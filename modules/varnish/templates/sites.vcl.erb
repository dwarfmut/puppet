# Configuração de Backend do Site <%= @vhost %> Gerenciado Pelo Puppet

backend <%= @title %> {
  .host = "<%= @host %>";
  .port = "<%= @port %>";
  .probe = {
    .request =
      "GET / HTTP/1.1"
      "Host: <%= @vhost %>"
      "Connection: close";
    .expected_response = 200;
    .interval = 1s;
    .timeout = 30s;
    .threshold = 3;
  }
}

sub vcl_recv {
  if (req.http.host ~ "^(.*)<%= @vhost %>$" && req.url ~ "^<%= @url %>$") {
    set req.backend_hint = <%= @title %>;
    
   <%- @nocache.each  do | nocache_item | %>     
   if (req.url ~ "^<%= nocache_item %>") {
     return(pass);  
   } 
   <%- end %>
  }
}

sub vcl_backend_response {
  <%- @cache.each do | cache_item | %>
  if (req.http.host ~ "^(.*)<%= @vhost %>$" && req.url ~ <%= cache_item['url'] %>) {
    set beresp.http.Cache-Control = "<%= cache_item['time'] %>"; 
    set beresp.ttl = "<%= cache_item['time'] + 's' %>";
  } 
  <%- end %>
}

sub vcl_deliver {
  if (req.backend_hint == <%= @title %> {
    unset resp.http.X-Varnish;
    unset resp.http.X-Grace;
    unset resp.http.X-Cache-Hits;
    unset resp.http.X-Cache;
    unset resp.http.Server;
    unset resp.http.Via;
  }
}
